<div class="p-6 h-full overflow-y-auto">
  <!-- Project Header -->
  <div class="flex justify-between items-start mb-6">
    <div class="flex-1">
      <div class="flex items-center gap-4 mb-4">
        <div *ngIf="!isEditingName">
          <h2 class="text-3xl font-bold text-gray-800 dark:text-white">{{ project.name }}</h2>
          <button *ngIf="canManageProject" (click)="startEditingName()"
            class="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-1">
            Edit Name
          </button>
        </div>
        <div *ngIf="isEditingName" class="flex items-center gap-2">
          <input [(ngModel)]="editedProjectName" (keyup.enter)="saveProjectName()" (keyup.escape)="cancelEditingName()"
            class="text-3xl font-bold bg-transparent border-b-2 border-blue-500 focus:outline-none text-gray-800 dark:text-white">
          <button (click)="saveProjectName()"
            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
            Save
          </button>
          <button (click)="cancelEditingName()"
            class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
            Cancel
          </button>
        </div>
      </div>

      <p class="text-gray-500 dark:text-gray-400 mb-4">{{ project.scenario }}</p>

      <!-- Project Manager Section -->
      <div *ngIf="project.projectManager" class="flex items-center gap-4 mb-4">
        <div class="flex items-center gap-2">
          <img [src]="project.projectManager.avatar" [alt]="project.projectManager.name"
            class="w-10 h-10 rounded-full object-cover ring-2 ring-white dark:ring-gray-800">
          <div>
            <p class="font-semibold text-gray-700 dark:text-gray-200">{{ project.projectManager.name }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Project Manager</p>
          </div>
        </div>
      </div>

      <div *ngIf="!project.projectManager && availableManagers.length > 0" class="mb-4">
        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Assign a Project Manager:</p>
        <select (change)="onManagerSelected($event)"
          class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
          <option value="">Select Manager...</option>
          <option *ngFor="let manager of availableManagers" [value]="manager.id">
            {{ manager.name }} - {{ manager.role }}
          </option>
        </select>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <span [class]="getStatusBadgeClass(project.status)">{{ formatStatus(project.status) }}</span>

      <!-- Edit Mode Toggle -->
      <button *ngIf="canManageProject" (click)="toggleEditMode()" [disabled]="isEditMode && !hasUnsavedChanges"
        class="px-4 py-2 text-sm font-medium text-white rounded-md transition-colors shadow-sm flex items-center gap-2"
        [ngClass]="{
          'bg-green-600 hover:bg-green-700': isEditMode && hasUnsavedChanges,
          'bg-gray-400 cursor-not-allowed': isEditMode && !hasUnsavedChanges,
          'bg-blue-600 hover:bg-blue-700': !isEditMode
        }">
        <svg *ngIf="!isEditMode" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
        </svg>
        <svg *ngIf="isEditMode" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {{ isEditMode ? 'Save Changes' : 'Edit Project' }}
      </button>

      <button *ngIf="currentUser && currentUser.role === 'admin'" (click)="archiveProject()"
        class="p-2 text-gray-500 rounded-full hover:bg-yellow-100 hover:text-yellow-600 dark:hover:bg-yellow-900/50 dark:hover:text-yellow-400 transition"
        title="Archive Project">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
        </svg>
      </button>
      <button *ngIf="currentUser?.role === 'admin'" (click)="deleteProject()"
        class="p-2 text-gray-500 rounded-full hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400 transition"
        title="Delete Project">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 2 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Overall Progress -->
  <div class="mb-8">
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Overall Progress</span>
        <span class="text-sm font-bold text-gray-900 dark:text-white">{{ project.overallProgress }}%</span>
      </div>
      <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
        <div [class]="getProgressBarColorByPercentage(project.overallProgress)"
          class="h-4 rounded-full transition-all duration-500" [style.width.%]="project.overallProgress"></div>
      </div>
    </div>
  </div>

  <!-- Stages -->
  <div class="space-y-6">
    <div *ngFor="let stage of project.stages"
      class="bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
      <!-- Stage Header -->
      <div (click)="toggleStage(stage)"
        class="p-4 flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800/50 transition-colors">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <h4 class="font-semibold text-lg text-gray-800 dark:text-gray-100">{{ stage.name }}</h4>
            <!-- Stage Assignees (Avatars) -->
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700">
            <div [class]="getProgressBarColorByPercentage(stage.progress)" [style.width.%]="stage.progress"
              class="h-2 rounded-full transition-all duration-500"></div>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <span [class]="getStatusBadgeClass(stage.status)">{{ (stage.status?.label || stage.status) | titlecase
            }}</span>
          <span class="transform transition-transform" [class.rotate-180]="stage.isOpen">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </span>
        </div>
      </div>

      <!-- Stage Content -->
      <div *ngIf="stage.isOpen" class="p-4 border-t border-gray-200 dark:border-gray-700">

        <!-- Assigned Personnel -->
        <div class="mb-6">
          <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">Assigned Stage Personnel</h5>
          <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-md">
            <div class="flex items-center -space-x-2">
              <ng-container *ngFor="let user of stage.assignedTeamMembers">
                <div class="relative group/avatar">
                  <div
                    class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm ring-2 ring-white dark:ring-gray-800"
                    [title]="user.name">
                    <img *ngIf="user.avatar" [src]="user.avatar" class="w-full h-full rounded-full object-cover">
                    <span *ngIf="!user.avatar">{{ user.name.charAt(0) }}</span>
                  </div>
                  <!-- Remove Button (Only in Edit Mode) -->
                  <button *ngIf="isEditMode && canManageProject" (click)="removeUserFromStage(stage, user)"
                    class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover/avatar:opacity-100 transition-opacity"
                    title="Remove user">
                    &times;
                  </button>
                </div>
              </ng-container>
              <span *ngIf="stage.assignedTeamMembers.length === 0" class="text-sm text-gray-500 ml-2">No one
                assigned</span>
            </div>

            <!-- Assign Dropdown: Removed (Background assignment only) -->
          </div>
        </div>

        <!-- Tasks Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <h5 class="font-semibold text-gray-700 dark:text-gray-300">Tasks</h5>

            <!-- Add Task: Only visible in Edit Mode -->
            <button *ngIf="isEditMode && canManageProject" (click)="openTaskModal(stage.id)"
              class="flex items-center gap-1 px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Task
            </button>
          </div>

          <div class="space-y-3">
            <div *ngFor="let task of stage.tasks"
              class="group flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 hover:shadow-sm transition-shadow">

              <!-- Left: Checkbox & Name -->
              <div class="flex items-center gap-3 flex-1">
                <!-- Checkbox: Disabled unless user has permission (handled by canEditTask) -->
                <input type="checkbox" [checked]="task.isCompleted" [disabled]="!canEditTask(task)"
                  (change)="toggleTaskCompletion(task)"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 disabled:opacity-50 cursor-pointer">

                <!-- Name: View/Edit Logic -->
                <ng-container *ngIf="isEditMode && canManageProject; else viewName">
                  <input [(ngModel)]="task.name" (blur)="updateTask(task)" (input)="onFieldChange()"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-blue-500 focus:border-blue-500">
                </ng-container>
                <ng-template #viewName>
                  <span class="text-gray-800 dark:text-gray-200 font-medium" [class.line-through]="task.isCompleted"
                    [class.text-gray-500]="task.isCompleted">
                    {{ task.name }}
                  </span>
                </ng-template>
              </div>

              <!-- Right: Meta Info & Actions -->
              <div class="flex items-center gap-4">
                <!-- Status Badge (Dynamic Color) -->
                <span [class]="getStatusBadgeClass(getTaskStatus(task))">{{ getTaskStatus(task).label }}</span>

                <!-- Date: View/Edit Logic -->
                <ng-container *ngIf="isEditMode && canManageProject; else viewDate">
                  <input type="date" [ngModel]="task.endDate | date:'yyyy-MM-dd'"
                    [max]="project.deadline | date:'yyyy-MM-dd'"
                    (ngModelChange)="task.endDate = $event; updateTask(task); onFieldChange()"
                    class="text-xs border border-gray-300 rounded px-2 py-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </ng-container>
                <ng-template #viewDate>
                  <span class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">
                    {{ task.endDate | date:'MMM d' }}
                  </span>
                </ng-template>

                <!-- Avatars (Restored) -->
                <div class="flex items-center -space-x-2">
                  <ng-container *ngFor="let user of task.assignedTeamMembers">
                    <div class="relative group/avatar">
                      <div
                        class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-xs ring-2 ring-white dark:ring-gray-800"
                        [title]="user.name">
                        <img *ngIf="user.avatar" [src]="user.avatar" class="w-full h-full rounded-full object-cover">
                        <span *ngIf="!user.avatar">{{ user.name.charAt(0) }}</span>
                      </div>
                      <!-- Remove Button (Only in Edit Mode) -->
                      <button *ngIf="isEditMode && canManageProject" (click)="removeUserFromTask(task, user)"
                        class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3 h-3 flex items-center justify-center text-[10px] opacity-0 group-hover/avatar:opacity-100 transition-opacity"
                        title="Remove user">
                        &times;
                      </button>
                    </div>
                  </ng-container>
                </div>

                <!-- Assign Dropdown (Restored: Visible only in Edit Mode) -->
                <select *ngIf="isEditMode && canManageProject"
                  (change)="assignUserToTask(task, $event); onFieldChange()"
                  class="text-xs bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded focus:ring-blue-500 focus:border-blue-500 py-1 pl-2 pr-6">
                  <option value="">Assign...</option>
                  <option *ngFor="let user of availableManagers" [value]="user.id">
                    {{ user.name }}
                  </option>
                </select>
              </div>
            </div>

            <div *ngIf="stage.tasks.length === 0" class="text-center py-4 text-gray-500 dark:text-gray-400">
              No tasks in this stage yet.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>